{% extends "fba/base.html" %}

{% block content %}
    <div class="price_calculator_container">
        <div class="price_calculator">

            <p>
                <label for="country">Country</label>
                <select name="country" id="country">
                    {% for country in countries %}<option value="{{ country.id }}">{{ country }}</option>{% endfor %}
                </select>
            </p>

            <p>
                <label for="selling_price">Selling Price</label>
                <input type="number" step="1" name="selling_price" id="selling_price">
            </p>

            <p>
                <label for="stock_level">Stock Level</label>
                <input type="number" step="1" name="stock_level" id="stock_level">
            </p>

            <p>
                <label for="quantity">Quantity</label>
                <input type="number" step="1" name="quantity" id="quantity">
            </p>

            <p>
                <label for="weight">Weight</label>
                <input type="number" step="1" name="weight" id="weight">
            </p>

            <p>
                <label for="purchase_price">Purchase Price</label>
                <span>£</span>
                <input type="number" step="0.01" name="purchase_price" id="purchase_price">
            </p>

            <p>
                <label for="fba_fee">FBA Fee</label>
                <input type="number" step="0.01" name="fba_fee" id="fba_fee">
            </p>

            <p>
                <label for="zero_rated">Zero Rated</label>
                <input type="checkbox" name="zero_rated" id="zero_rated">
            </p>

        </div>

        <div class="price_calculator_results">

            <p>
                <label for="purchase_price_foreign">Purchase Price</label>
                <span class="currency_symbol"></span>
                <input type="number"
                       step="0.01"
                       name="purchase_price_foreign"
                       id="purchase_price_foreign"
                       readonly>
            </p>

            <p>
                <label for="channel_fee">Channel Fee</label>
                <span class="currency"></span>
                <input type="number"
                       step="0.01"
                       name="channel_fee"
                       id="channel_fee"
                       readonly>
            </p>

            <p>
                <label for="vat">VAT</label>
                <span class="currency_symbol"></span>
                <input type="number" step="0.01" name="vat" id="vat" readonly>
            </p>

            <p>
                <label for="profit">Profit £</label>
                <input type="number" step="0.01" name="profit" id="profit" readonly>
            </p>

            <p>
                <label for="percentage">Profit Percentage</label>
                <span>%</span>
                <input type="number" step="0.01" name="percentage" id="percentage" readonly>
            </p>

            <p>
                <label for="postage_to_fba">Total Postage</label>
                <span>£</span>
                <input type="number"
                       step="0.01"
                       name="postage_to_fba"
                       id="postage_to_fba"
                       readonly>
            </p>

            <p>
                <label for="postage_per_item">Postage Per Item</label>
                <span>£</span>
                <input type="number"
                       step="0.01"
                       name="postage_per_item"
                       id="postage_per_item"
                       readonly>
            </p>

            <p>
                <label for="max_quantity_no_stock">Maximum Sendable</label>
                <input type="number"
                       class="max_quantity_no_stock"
                       id="max_quantity_no_stock"
                       readonly>
            </p>

        </div>
    </div>

{% endblock content %}

{% block script %}

    <script>
    function refresh_calculator() {
        var data = {
            "zero_rated": $("#zero_rated").is(':checked'),
            "selling_price": $("#selling_price").val(),
            "country": $("#country").val(),
            "purchase_price": $("#purchase_price").val(),
            "quantity": $("#quantity").val(),
            "fba_fee": $("#fba_fee").val(),
            "weight": $("#weight").val(),
            "stock_level": $("#stock_level").val()
        }
        if ((data["selling_price"] === "") || (data["fba_fee"] === "") || (data["country"] === "")) {
            return
        }
        $.ajax({
            url: "{% url 'fba:price_calculator' %}",
            type: "POST",
            dataType: "JSON",
            data: data,
            success: function (result) {
                $("#purchase_price_foreign").val(result["purchase_price"]);
                $("#channel_fee").val(result["channel_fee"]);
                $("#vat").val(result["vat"]);
                $("#postage_to_fba").val(result["postage_to_fba"]);
                $("#postage_per_item").val(result["postage_per_item"]);
                $("#profit").val(result["profit"]);
                $("#percentage").val(result["percentage"]);
                $("span.currency_symbol").text(result["currency_symbol"]);
                $("#max_quantity_no_stock").val(result["max_quantity_no_stock"]);
            }
        })
    }

    $(document).ready(function () {
        $("#profit").parent().css("font-weight", "bold");
        $("#profit").css("font-weight", "bold");

        $('input,textarea,select').filter('[required]').filter(':enabled').parent().find("label").addClass(
            "required");
        $('form').submit(function (e) {
            if (!confirm(
                    "Are you sure you want to {% if form.instance.id %}update{% else %}create{% endif %} this FBA order?"
                )) {
                e.preventDefault();
            }
        });

        $("#country").change(function () {
            $("#quantity").val("");
            refresh_calculator();
        });

        $("#selling_price").change(function () {
            refresh_calculator();
        });

        $("#quantity").change(function () {
            refresh_calculator();
        });

        $("#fba_fee").change(function () {
            refresh_calculator();
        });

        $("#purchase_price").change(function () {
            refresh_calculator();
        });

        $("#weight").change(function () {
            refresh_calculator();
        });

        $("#zero_rated").change(function () {
            refresh_calculator();
        });

        $(".prioritise").click(function () {
            var order_id = $(this).attr("id").split("_").pop();
            $.ajax({
                url: "{% url 'fba:priortise_fba_order' %}",
                data: {
                    'order_id': order_id
                },
                type: "GET",
                success: function (response) {
                    alert("Order set to top priority")
                }
            })
        });

        refresh_calculator();

    });
    </script>

{% endblock script %}
