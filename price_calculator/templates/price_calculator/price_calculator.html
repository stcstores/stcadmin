{% extends "inventory/base.html" %}
{% load staticfiles %}
{% load inventory_extras %}

{% block additional_head %}
{{ block.super }}
<script src="{% static 'scripts/price_calculator.js' %}"></script>
{% endblock %}

{% block page_title %}Product Price Calculator{% endblock %}

{% block content %}{{ block.super }}
    <style>
        .price_negative {
            color: red;
        }
        .price_zero, .price_positive {
            color: black;
        }
        #profit, #profit_percentage {
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>

    <table class="price_calculator">
        <tr>
            <th>Country</th>
            <th>Shipping Method</th>
            <th>Weight</th>
            <th>Purchase Price</th>
            <th>Price</th>
            <th>VAT</th>
        </tr>
        <tr class="price_calculator_product">
            <td>
                <select name="country" id="country">
                    {% for country in countries %}
                        <option value="{{ country }}">{{ country }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <select name="shipping_method" id="shipping_method">
                    {% for package_type in package_types %}
                        <option value="{{ package_type }}">{{ package_type }}</option>
                    {% endfor %}
                </select>
            </td>
            <td><input id="weight" type="number" step="1" value="50"></td>
            <td><input id="purchase_price" type="number" step="0.01" value="5"></td>
            <td><input id="sale_price" type="number" step="0.01" value="15.50"></td>
            <td>
                <select name="vat_rate" id="vat_rate">
                </select>
            </td>
        </tr>
    </table>
    <table class="price_calculator">
        <tr>
            <th>Ex VAT Price</th>
            <th>Postage</th>
            <th>Channel Fee</th>
            <th>Profit</th>
            <th>Profit Percentage</th>
        </tr>
        <tr>
            <td id="ex_vat_price"></td>
            <td id="postage"></td>
            <td id="channel_fee"></td>
            <td id="profit"></td>
            <td id="profit_percentage"></td>
        </tr>
    </table>

{% endblock %}

{% block script %}
<script>

    get_postage_price_url = "{% url 'price_calculator:get_shipping_price' %}";

    $(document).ready(function() {

        var ex_vat_price = 5;
        var vat_rate = $('#vat_rate').val();
        var purchase_price = $('#purchase_price').val();
        var postage_price = 5;
        var data = {
            'sale_price': ex_vat_price,
            'postage_price': postage_price,
            'purchase_price': purchase_price,
            'vat_rate': vat_rate,
            'channel_fee_percentage': 15,
        }
        calculator = new PriceCalculator(data)
        calculator.change = function() {
            $('#vat').html(format_price(calculator.get_vat()));
            $('#ex_vat_price').html(format_price(calculator.get_ex_vat()));
            $('#postage').html(format_price(calculator.get_postage_price()));
            $('#purchase_price').html(format_price(calculator.get_purchase_price()));
            $('#channel_fee').html(format_price(calculator.get_channel_fee()));
            var profit = calculator.get_profit();
            $('#profit').html(format_price(profit));
            if (profit > 0) {
                $('#profit').css('color', 'black');
            } else {
                $('#profit').css('color', 'red');
            }
            var profit_percentage = parseInt(calculator.get_profit_percentage());
            $('#profit_percentage').html(profit_percentage + '%');
            if (profit_percentage > 20) {
                $('#profit_percentage').css('color', 'green');
            } else if (profit_percentage < 10) {
                $('#profit_percentage').css('color', 'red');
            } else {
                $('#profit_percentage').css('color', 'orange');
            }
        };

        calculator.set_sale_price($(this).val());

        $('#purchase_price').change(function() {
            calculator.set_purchase_price($(this).val());
        });

        $('#postage_method').change(function() {
            calculator.set_postage_price($(this).val());
        });

        function update_postage_price(calculator) {
            var country = $('#country').val();
            var weight = $('#weight').val();
            var package_type = $('#shipping_method').val();
            var price = calculator.sale_price;
            get_postage_price(calculator, country, package_type, weight, price);
        };

        $('#country').change(function() {update_postage_price(calculator)});
        $('#weight').change(function() {update_postage_price(calculator)});
        $('#shipping_method').change(function() {update_postage_price(calculator)});
        $('#sale_price').change(function() {
            calculator.set_sale_price($(this).val());
            update_postage_price(calculator);
        });
        $('#sale_price').change();
    });

    function update_vat_rates(vat_rates, calculator) {
        var vat_rate_select = $('#vat_rate');
        vat_rate_select.html('');
        if (vat_rates.length > 0) {
            $(vat_rates).each(function() {
                vat_rate_select.append(
                    $("<option>").attr('value', this.percentage).text(this.name));
            });
            vat_rate_select.change(function() {
                calculator.set_vat_rate($(this).val());
            });
            vat_rate_select.attr('disabled', false);
        } else {
            vat_rate_select.append(
                $("<option>").attr('value', 0).text('VAT Not Applicable'));
            vat_rate_select.attr('disabled', true);
        }
        vat_rate_select.change();
    }
</script>
{% endblock %}
