{% extends "inventory/range_settings.html" %}
{% load staticfiles %}
{% load inventory_extras %}

{% block additional_head %}
{{ block.super }}
<script src="{% static 'scripts/price_calculator.js' %}"></script>
{% endblock %}

{% block page_title %}Range Price Calculator{% endblock %}

{% block content %}{{ block.super }}
    <style>
        .price_negative {
            color: red;
        }
        .price_zero, .price_positive {
            color: black;
        }
    </style>

    <select name="country" id="country">
        {% for country in countries %}
            <option value="{{ country }}">{{ country }}</option>
        {% endfor %}
    </select>

    <table class="price_calculator">
        <tr>
            <th>SKU</th>
            <th>Product Name</th>
            <th>Price</th>
            <th>Ex VAT Price</th>
            <th>VAT</th>
            <th>Postage</th>
            <th>Purchase Price</th>
            <th>Channel Fee</th>
            <th>Profit</th>
            <th>Profit Percentage</th>
        </tr>
        {% for product in product_range.products %}
            <tr class="price_calculator_product">
                <th>{{ product.sku }}</th>
                <td>{{ product.full_name }}</td>
                <td><input id="{{ product.id }}_sale_price" type="number" step="0.01"></td>
                <td id="{{ product.id }}_ex_vat_price"></td>
                <td id="{{ product.id }}_vat"></td>
                <td id="{{ product.id }}_postage"></td>
                <td id="{{ product.id }}_purchase_price"></td>
                <td id="{{ product.id }}_channel_fee"></td>
                <td id="{{ product.id }}_profit"></td>
                <td id="{{ product.id }}_profit_percentage"></td>
            </tr>
        {% endfor %}
    </table>

{% endblock %}

{% block script %}
<script>

    get_postage_price_url = "{% url 'price_calculator:get_shipping_price' %}";

    vat_rates = {
        '5': 20,
    }

    postage_prices = {
        'Large Letter': 0.63,
        'Packet': 2.15,
        'Heavy and Large': 3.12,
        'Courier': 7.56,
    }

    function update_vat_rates(vat_rates, calculator) {
        if (vat_rates.length == 0) {
            {% for product in product_range.products %}
            calcs['{{ product.id }}'].set_vat_rate(0);
            {% endfor %}
        }
        $(vat_rates).each(function() {
            {% for product in product_range.products %}
            if (this.cc_id == {{ product.vat_rate_id }}) {
                calcs['{{ product.id }}'].set_vat_rate(this.percentage);
            }
            {% endfor %}
        });
    }

    $(document).ready(function() {
        calcs = {};
        {% for product in product_range.products %}
        var ex_vat_price = {{ product.base_price }};
        var vat_rate = 20;
        var options = {
            {% for option in product.options %}
                '{{ option.option_name }}': '{{ option.value }}',
            {% endfor %}
        }
        var purchase_price = options['Purchase Price'];
        var package_type = options['Package Type'];
        var postage_price = 10;
        var data = {
            'sale_price': ex_vat_price,
            'postage_price': postage_price,
            'purchase_price': purchase_price,
            'vat_rate': vat_rate,
            'channel_fee_percentage': 15,
        }
        calcs['{{ product.id }}'] = new PriceCalculator(data)
        calcs['{{ product.id}}'].change = function() {
            $('#{{ product.id }}_vat').html(
                format_price(calcs['{{ product.id}}'].get_vat()));
            $('#{{ product.id }}_ex_vat_price').html(
                format_price(calcs['{{ product.id}}'].get_ex_vat()));
            $('#{{ product.id }}_postage').html(
                format_price(calcs['{{ product.id}}'].get_postage_price()));
            $('#{{ product.id }}_purchase_price').html(
                format_price(calcs['{{ product.id}}'].get_purchase_price()));
            $('#{{ product.id }}_channel_fee').html(
                format_price(calcs['{{ product.id}}'].get_channel_fee()));
            var profit = calcs['{{ product.id}}'].get_profit();
            $('#{{ product.id }}_profit').html(format_price(profit));
            if (profit > 0) {
                $('#{{ product.id }}_profit').css('color', 'black');
            } else {
                $('#{{ product.id }}_profit').css('color', 'red');
            }
            var profit_percentage = parseInt(
                calcs['{{ product.id}}'].get_profit_percentage());
            $('#{{ product.id }}_profit_percentage').html(profit_percentage + '%');
            if (profit_percentage > 20) {
                $('#{{ product.id }}_profit_percentage').css('color', 'green');
            } else if (profit_percentage < 10) {
                $('#{{ product.id }}_profit_percentage').css('color', 'red');
            } else {
                $('#{{ product.id }}_profit_percentage').css('color', 'orange');
            }
        };
        var initial_price = parseFloat(
            ex_vat_price + calcs['{{ product.id}}'].get_vat() + postage_price
        ).toFixed(2);

        $('#{{ product.id }}_sale_price').val(initial_price);
        $('#{{ product.id }}_sale_price').change();
        {% endfor %}
        $('#country').change(function() {
            {% for product in product_range.products %}
            var country = $(this).val();
            var package_type = options['Package Type'];
            var price = calcs['{{ product.id}}'].sale_price;
            get_postage_price(
                calcs['{{ product.id}}'], country, package_type,
                {{ product.weight }}, price);
            {% endfor %}
        });
        {% for product in product_range.products %}
        calcs['{{ product.id}}'].set_sale_price(
            $('#{{ product.id }}_sale_price').val());
        $('#{{ product.id }}_sale_price').change(function() {
            calcs['{{ product.id}}'].set_sale_price($(this).val());
            $('#country').change();
        });
        {% endfor %}
        $('#country').change();
    });
</script>
{% endblock %}
