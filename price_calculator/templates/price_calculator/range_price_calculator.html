{% extends "inventory/range_settings.html" %}
{% load staticfiles %}
{% load inventory_extras %}
{% load reference_extras %}

{% block additional_head %}
{{ block.super }}
<script src="{% static 'scripts/price_calculator.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/price_calculator.css' %}">
<link rel="stylesheet" href="{% static 'css/input-add-on.css' %}">
{% endblock %}

{% block page_title %}Range Price Calculator{% endblock %}

{% block content %}{{ block.super }}
<h1 class="page_title">Range Price Calculator</h1>
{% help_button 'inventory_help' 'inventory-price_calculator' %}
<h2>{{ product_range.name }}</h2>

<div class="price_calculator_input">

  <div class="InputAddOn">
    <label for="country" class="InputAddOn-item">Country</label>
    <select name="country" id="country">
        {% for country in countries %}
            <option value="{{ country }}">{{ country }}</option>
        {% endfor %}
    </select>
  </div>

  <div class="InputAddOn">
    <label for="channel_fee" class="InputAddOn-item">Channel Fee</label>
    <select name="channel_fee" id="channel_fee_input" size="{{ channel_fees|length }}">
      {% for fee in channel_fees %}
      <option value="{{ fee.fee_percentage }}"{% if forloop.first %} selected{% endif %}>{{ fee.name }}: {{ fee.fee_percentage }}%</option>
      {% endfor %}
    </select>
  </div>

</div>

    <table class="price_calculator">
        <tr>
            <th>SKU</th>
            <th>Product Name</th>
            <th>Price GBP</th>
            <th id="currency_code"></th>
            <th>Ex VAT Price</th>
            <th>VAT</th>
            <th>Postage</th>
            <th>Purchase Price</th>
            <th>Channel Fee</th>
            <th>Profit</th>
            <th>Profit Percentage</th>
        </tr>
        {% for product in product_range.products %}
            <tr class="price_calculator_product">
                <th>{{ product.sku }}</th>
                <td>{{ product.full_name }}</td>
                <td class="sale_price">
                  <div class="InputAddOn">
                    <span class="InputAddOn-item">&pound;</span>
                    <input id="{{ product.id }}_sale_price" class="currency_input InputAddOn-field" size="2" />
                  </div>
                </td>
                <td class="foreign_sale_price listing_price">
                  <div class="InputAddOn">
                    <span class="currency_symbol InputAddOn-item"></span>
                    <input id="{{ product.id }}_foriegn_price" class="currency_input InputAddOn-field" size="2" />
                  </div>
                </td>
                <td id="{{ product.id }}_ex_vat_price"></td>
                <td id="{{ product.id }}_vat"></td>
                <td id="{{ product.id }}_postage"></td>
                <td id="{{ product.id }}_purchase_price"></td>
                <td id="{{ product.id }}_channel_fee"></td>
                <td id="{{ product.id }}_profit"></td>
                <td id="{{ product.id }}_profit_percentage"></td>
            </tr>
        {% endfor %}
    </table>
{% endblock %}

{% block script %}
<script>

    get_postage_price_url = "{% url 'price_calculator:get_shipping_price' %}";

    function update_vat_rates(vat_rates, calculator) {
        if (vat_rates.length == 0) {
            {% for product in product_range.products %}
            calcs['{{ product.id }}'].set_vat_rate(0);
            {% endfor %}
        }
        $(vat_rates).each(function() {
            {% for product in product_range.products %}
            calcs['{{ product.id }}'].set_vat_rate({{ product.vat_rate }});
            {% endfor %}
        });
    }

    $(document).ready(function() {
        calcs = {};
        var options = {
            {% for product in product_range.products %}
                '{{ product.id }}': {},
            {% endfor %}
        }
        {% for product in product_range.products %}
        var ex_vat_price = {{ product.base_price }};
        var vat_rate = 20;
        options['{{ product.id }}'] = {
            {% for option in product.options %}
                '{{ option.option_name }}': '{{ option.value }}',
            {% endfor %}
        }
        var purchase_price = options['{{ product.id }}']['Purchase Price'];
        var package_type = options['{{ product.id }}']['Package Type'];
        var postage_price = 10;
        var channel_fee = $('#channel_fee_input').val();
        var data = {
            'sale_price': ex_vat_price,
            'postage_price': postage_price,
            'purchase_price': purchase_price,
            'vat_rate': vat_rate,
            'channel_fee_percentage': channel_fee,
            'min_channel_fee': 0,
        }
        calcs['{{ product.id }}'] = new PriceCalculator(data)

        calcs['{{ product.id }}'].change = function() {
            // Format Price
            if (calcs['{{ product.id}}'].currency_code == 'GBP') {
                $('#currency_code').hide();
                $('#{{ product.id }}_foriegn_price').closest('td').hide();
                $('#{{ product.id }}_sale_price').closest('td').addClass('listing_price');
            } else {
              $('#{{ product.id }}_sale_price').closest('td').removeClass('listing_price');
                $('#currency_code').text(
                    'Price (' + calcs['{{ product.id}}'].currency_code + ')');
                $('#currency_code').show();
                $('#{{ product.id }}_foriegn_price').closest('td').show();
                $('#{{ product.id }}_foriegn_price').val(
                    calcs['{{ product.id}}'].get_foriegn_sale_price());
                $('.currency_symbol').text(calcs['{{ product.id}}'].currency_symbol);
            }
            $('#{{ product.id }}_vat').html(
                format_price(calcs['{{ product.id}}'].get_vat()));
            $('#{{ product.id }}_ex_vat_price').html(
                format_price(calcs['{{ product.id}}'].get_ex_vat()));
            $('#{{ product.id }}_postage').html(
                format_price(calcs['{{ product.id}}'].get_postage_price()));
            $('#{{ product.id }}_purchase_price').html(
                format_price(calcs['{{ product.id}}'].get_purchase_price()));
            $('#{{ product.id }}_channel_fee').html(
                format_price(calcs['{{ product.id}}'].get_channel_fee()));
            var profit = calcs['{{ product.id}}'].get_profit();
            $('#{{ product.id }}_profit').html(format_price(profit));
            if (profit > 0) {
                $('#{{ product.id }}_profit').removeClass('loss');
            } else {
                $('#{{ product.id }}_profit').addClass('loss');
            }

            // Format Percentage
            var profit_percentage = parseInt(
                calcs['{{ product.id}}'].get_profit_percentage());
            $('#{{ product.id }}_profit_percentage').html(profit_percentage + '%');
            if (profit_percentage > 20) {
                format_percentage($('#{{ product.id }}_profit_percentage'), 'high');
            } else if (profit_percentage < 10) {
                format_percentage($('#{{ product.id }}_profit_percentage'), 'warning');
            } else {
                format_percentage($('#{{ product.id }}_profit_percentage'), 'low');
            }
        };

        var initial_price = parseFloat(
            ex_vat_price + calcs['{{ product.id}}'].get_vat() + postage_price
        ).toFixed(2);

        $('#{{ product.id }}_sale_price').val(initial_price);
        $('#{{ product.id }}_sale_price').change();
        {% endfor %}
        $('#country').change(function() {
            {% for product in product_range.products %}
            var country = $(this).val();
            var package_type = options['{{ product.id }}']['Package Type'];
            var price = calcs['{{ product.id }}'].sale_price;
            get_postage_price(
                calcs['{{ product.id}}'], country, package_type,
                {{ product.weight }}, price);
            {% endfor %}
        });
        {% for product in product_range.products %}
        calcs['{{ product.id}}'].set_sale_price(
            $('#{{ product.id }}_sale_price').val());
        $('#{{ product.id }}_sale_price').change(function() {
            calcs['{{ product.id}}'].set_sale_price($(this).val());
            $('#country').change();
        });
        $('#{{ product.id }}_foriegn_price').change(function() {
            var foreign_price = $(this).val();
            var exchange_rate = calcs['{{ product.id}}'].exchange_rate;
            var sale_price = parseFloat(foreign_price * exchange_rate).toFixed(2);
            $('#{{ product.id }}_sale_price').val(sale_price);
            $('#{{ product.id }}_sale_price').change();
        });
        {% endfor %}
        $('#channel_fee_input').change(function() {
          {% for product in product_range.products %}
              calcs['{{ product.id }}'].set_channel_fee_percentage($(this).val());
          {% endfor %}
        });
        $('#country').change();
    });
</script>
{% endblock %}
