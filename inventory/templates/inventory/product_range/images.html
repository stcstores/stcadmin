{% extends "inventory/product_range/product_range_base.html" %}

{% load static %}

{% block page_title %}Product Images{% endblock %}

{% block additional_head %}{{ block.super }}
  <link rel="stylesheet" href="{% static "css/images.css" %}">
{% endblock %}

{% block content %}{{ block.super }}

<form action="" method="POST" enctype="multipart/form-data">{% csrf_token %}
  <h3>
    <label for="{{ form.cloud_commerce_images.name }}" class="add_images_label"></label>
    <p>{{ form.cloud_commerce_images }}</p>
  </h3>
</form>

{% for option, values in options.items %}
<p>{{ option }}: {% for value, product_ids in values.items %}
  <button onclick="select_products([{% for p_id in product_ids %}{{ p_id }}, {% endfor %}])">{{ value }}</button>{% endfor %}
</p>
{% endfor %}

<table class="image_table">
  <tr>
    <th>Product</th>
    <th><button id="toggle_selected">Toggle</button></th>
  </tr>
  {% for product, images in products.items %}
  <tr id="row_{{ product.product_ID }}">
    <td class="product_id" hidden>{{ product.product_ID }}</td>
    <td class="sku">{{ product.SKU }}</td>
    <td class="selected"><input type="checkbox" id="select_{{ product.product_ID }}"></td>
    {% for image in images %}
    <td class="product_image">
      <img src="{{ image.URL }}" alt="{{ image.image_ID }}" height="100">
      <br>
      <a class="image_id" href="{{ image.URL }}" target="_blank">{{ image.image_ID }}</a>
      <p>
        <button class="move_image_left">&lt;</button>
        <button class="delete_image">&times;</button>
        <button class="move_image_right">&gt;</button>
      </p>
    </td>
    {% endfor %}
  </tr>
  {% endfor %}
</table>

{% endblock %}

{% block script %}{{ block.super }}
<script>
  function get_image_order(product_id) {
    var row = $('#row_' + product_id);
    var image_order = [];
    row.find('.product_image').each(function() {
      image_order.push($(this).find('.image_id').text());
    });
    return image_order
  }

  function select_products(product_ids) {
    var checkboxes = $('.selected input:checkbox');
    checkboxes.prop('checked', false);
    for (var i = 0; i < product_ids.length; i++) {
      $('#select_' + product_ids[i]).prop('checked', true);
    }
    $('.selected input:checkbox').change();
  }

  function update_image_order(product_id) {
    var url = '{% url "inventory:set_image_order" %}';
    var image_order = get_image_order(product_id);
    var data = {
      'product_ID': product_id,
      'image_order': image_order
    };
    $.post({
      url: url,
      data: JSON.stringify(data),
      success: function() {
        console.log(image_order);
      },
      error: function() {
        api_error();
      }
    });
  }

  function delete_image(image) {
    var url = '{% url "inventory:delete_image" %}';
    var image_id = image.find('.image_id').text();
    var data = {
      'image_id': image_id
    };
    $.post({
      url: url,
      data: JSON.stringify(data),
      success: function() {
        image.remove();
      },
      error: function() {
        api_error();
      }
    });
  }

  $(document).ready(function() {

    $('.move_image_left').click(function() {
      var image = $(this).closest('td');
      var product_id = image.closest('tr').find('.product_id').text();
      if (image.index() > 3) {
        image.insertBefore(image.prev());
      }
      update_image_order(product_id);
    });

    $('.move_image_right').click(function() {
      var image = $(this).closest('td');
      var product_id = image.closest('tr').find('.product_id').text();
      if (!(image.is(':last-child'))) {
        image.insertAfter(image.next());
      }
      update_image_order(product_id);
    });

    $('.delete_image').click(function() {
      var image = $(this).closest('td');
      delete_image(image);
    });

    $('#toggle_selected').click(function() {
      var checkboxes = $('.selected input:checkbox');
      var checked = $('.selected input:checked');
      if (checked.length === 0) {
        checkboxes.prop('checked', true);
      } else {
        checkboxes.prop('checked', false);
      }
      $('.selected input:checkbox').change();
    });

    $('.selected input:checkbox').change(function() {
      var checked = $('.selected input:checked');
      var product_id_input = $('#{{ form.product_ids.auto_id }}');
      var product_ids = [];
      checked.each(function() {
        var product_id = this.id.split('_')[1];
        product_ids.push(product_id);
      });
      if (checked.length == 0) {
        $('#{{ form.cloud_commerce_images.auto_id }}').attr('disabled', true);
        $('.add_images_label').text('Select products to add images');
      } else {
        $('#{{ form.cloud_commerce_images.auto_id }}').attr('disabled', false);
        $('.add_images_label').text('Add an image to the selected products');
      }
      product_id_input.val(JSON.stringify(product_ids));
    });

    $('#{{ form.cloud_commerce_images.auto_id }}').change(function() {
      $(this).closest('form').submit();
    });

    $('#{{ form.stcadmin_images.auto_id }}').change(function() {
      $(this).closest('form').submit();
    });

    $('.selected input:checkbox').change();
  });
</script>

{% endblock %}
