{% extends "inventory/range_settings.html" %}
{% load staticfiles %}
{% load inventory_extras %}

{% block additional_head %}
{{ block.super }}
<script src="{% static 'scripts/stock_manager.js' %}"></script>
<link rel="stylesheet" href="{% static 'scripts/selectize/selectize.css' %}">
<script src="{% static 'scripts/selectize/selectize.js' %}"></script>
{% endblock %}

{% block page_title %}Product Locations{% endblock %}

{% block content %}{{ block.super }}

<form action="" method="POST">{% csrf_token %}
    {{ bay_formset.management_form }}
    <table>
        {% for field in department_form %}
        <tr>
            <th><label for="{{ field.name }}">{{ field.label}}</label></th>
            <td colspan="2">{{ field }}</td>
        </tr>
        {% endfor %}
        <tr>
            <th>Product</th>
            <th>Stock Level</th>
            <th>Bays</th>
        </tr>
        {% for form in bay_formset %}
        {% if form.errors %}{{ form.errors }}{% endif %}
        <tr hidden><td>{{ form.product_id }}</td></tr>
        <tr>
            <td class="title_field">{{ form.product_name.value }}</td>
            <td class="stock_level_field">{{ form.stock_level.value }}</td>
            <td class="location_field">{{ form.locations }}</td>
        </tr>
        {% endfor %}
    </table>
    <input type="submit" value="Update Locations" />
</form>

{% endblock %}

{% block script %}
<script>

function get_bays() {
    return $('.location_field').find('select');
}

function disable_bays() {
    get_bays().each(function() {
        $(this)[0].selectize.disable();
    });
}

function enable_bays() {
    get_bays().each(function() {
        $(this)[0].selectize.enable();
    });
}

$(document).ready(function() {

    var warehouses = {% warehouses %};

    var department = $('select[name="department"]').change(function(){
        var value = $(this)[0].selectize.getValue();
        if (value == '') {
            disable_bays();
            return
        }
        enable_bays();
        set_department(value);
    });

    function set_department(department_id) {
        var options = warehouses[department_id];
        get_bays().each(function() {
            var selectize = $(this)[0].selectize;
            var value = selectize.getValue();
            selectize.clear();
            selectize.clearOptions();
            selectize.addOption(options);
            selectize.setValue(value);
        });
    }

    var department = $('select[name="department"]').change();
});

</script>

{% endblock %}
