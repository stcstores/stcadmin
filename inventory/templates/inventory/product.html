{% extends "inventory/base.html" %}
{% load static %}



{% block page_title %}{{ product_range.name }}{% endblock %}

{% block additional_head %}{{ block.super }}
<script>
  /* beautify preserve:start */
  {% include 'inventory/widgets/product_widgets.js' %}
  /* beautify preserve:end */
</script>
<link rel="stylesheet" href="{% static 'css/product_page.css' %}">
{% endblock %}

{% block content %}{{ block.super }}

<a href="{% url 'inventory:product_range' product_range.pk %}" class="button-link">
  <i class="fa-solid fa-arrow-left"></i> Back to Product Range
</a>

<div class="product_header">
  <div class="details">
    <p><span class="sku">{{ product.sku}}</span>: <span class="name">{{ product.full_name }}</span></p>
  </div>
</div>

<div class="page_center">

  <div class="product_form">
    <form action="" method="POST" autocomplete="off">{% csrf_token %}
      {% include "inventory/input_add_on_form.html" %}
      <button type="submit" class="save_button" disabled>Save</button>
    </form>
  </div>

  <div>
    <table class="variation_table">
      <tr>
        <th class="variation-selection">SKU</th>
        {% for option in product_range.variation_options %}
        <th>{{ option }}</th>
        {% endfor %}
        {% for option in product_range.listing_options %}
        <th class="listing_option">{{ option }}</th>
        {% endfor %}
        <th>Supplier SKU</th>
      </tr>
      {% for variation in product_range.products.variations %}
      <tr class="variation-selection {% if product == variation %}selected{% else %}not_selected{% endif %}"
        data-href="{% url 'inventory:product' variation.pk %}">
        <td class="sku">{{ variation.sku }}</td>
        {% for option, value in variation.variation.items %}
        <td class="option name">{{ value }}</td>
        {% endfor %}
        {% for option, value in variation.listing_options.items %}
        <td class="option listing_option name">{{ value }}</td>
        {% endfor %}
        <td class="sku">{{ variation.supplier_sku }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>

</div>
{% endblock %}

{% block script %}{{ block.super }}
<script>
  var form_changed = false;
  var price_selectors = ['#id_purchase_price', '#id_retail_price'];

  function set_variation_hover_style() {
    $('.variation_table .not_selected').hover(
      function () {
        $(this).find('td').css('background', '#ccfff1');
      },
      function () {
        $(this).find('td').css('background', '');
      }
    );
  }

  function variation_link_click() {
    $('.variation_table .not_selected').click(function () {
      if ((!form_changed) || (window.confirm(
          "Changes not saved.\nDo you want to leave without saving your changes?"))) {
        window.location = $(this).data('href');
      }
    });
  }

  function set_autoNumeric() {
    $.each(price_selectors, function (index, value) {
      $(value).attr({
        type: "text"
      });
      new AutoNumeric($(value)[0]).british({
        'unformatOnSubmit': true
      });
    });
  }

  function set_form_changed() {
    form_changed = true;
    $('.save_button').prop('disabled', false);
  }

  function set_form_changed_event_triggers() {
    $('.product_form input, .product_form select').on('input', set_form_changed);
    $('select').on('change', set_form_changed);
  }

  $(document).ready(function () {

    set_variation_hover_style();
    variation_link_click();
    set_autoNumeric();

    $(document).ready(function () { // After selectize and autoNumeric
      set_form_changed_event_triggers();
      $(".product_form form").keydown(function(event){
        if(event.keyCode == 13) {
          event.preventDefault();
          return false;
        }
      });
    });

  });
</script>
{% endblock %}