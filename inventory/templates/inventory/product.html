{% extends "inventory/base.html" %}
{% load static %}
{% load inventory_extras %}
{% load reference_extras %}

{% block page_title %}{{ product_range.name }}{% endblock %}

{% block additional_head %}{{ block.super }}
<script>
  {
    %
    include 'inventory/widgets/product_widgets.js' %
  }
</script>
<link rel="stylesheet" href="{% static 'css/product_page.css' %}">
{% endblock %}

{% block content %}{{ block.super }}
<div class="product_header">
  <div class="details">
    <p>SKU: <span class="sku">{{ product.sku}}</span></p>
  </div>
  <div class="identification">
    <p class="name">{{ product.product_range.name }}</p>
    <p>
      {% for key, value in product.variation.items %}
      <span class="option">{{ key }}</span>: <span class="name">{{ value }}</span>
      {% endfor %}
    </p>
    <p>
      {% for key, value in product.listing_options.items %}
      <span class="option">{{ key }}</span>: <span class="name">{{ value }}</span>
      {% endfor %}
    </p>
  </div>
</div>

<div class="page_center">

  <div class="product_form">
    <form action="" method="POST" autocomplete="off">{% csrf_token %}
      {% include "inventory/input_add_on_form.html" %}
      <button type="submit" class="save_button" disabled>Save</button>
    </form>
  </div>

  <table class="variation_table">
    <tr>
      <th>SKU</th>
      {% for option in product_range.variation_options %}
      <th>{{ option }}</th>
      {% endfor %}
      {% for option in product_range.listing_options %}
      <th class="listing_option">{{ option }}</th>
      {% endfor %}
      <th>Supplier SKU</th>
    </tr>
    {% for variation in product_range.products.all %}
    <tr class="{% if product == variation %}selected{% else %}not_selected{% endif %}"
      data-href="{% url 'inventory:product' variation.pk %}">
      <td class="sku">{{ variation.sku }}</td>
      {% for option, value in variation.variation.items %}
      <td class="option name">{{ value }}</td>
      {% endfor %}
      {% for option, value in variation.listing_options.items %}
      <td class="option listing_option name">{{ value }}</td>
      {% endfor %}
      <td class="sku">{{ variation.supplier_sku }}</td>
    </tr>
    {% endfor %}
  </table>

</div>
{% endblock %}

{% block script %}{{ block.super }}
<script>
  var form_changed = false;
  var price_selectors = ['#id_price', '#id_purchase_price', '#id_retail_price'];

  function set_variation_hover_style() {
    $('.variation_table .not_selected').hover(
      function () {
        $(this).find('td').css('background', '#ccfff1');
      },
      function () {
        $(this).find('td').css('background', '');
      }
    );
  }

  function variation_link_click() {
    $('.variation_table .not_selected').click(function () {
      if ((!form_changed) || (window.confirm(
          "Changes not saved.\nDo you want to leave without saving your changes?"))) {
        window.location = $(this).data('href');
      }
    });
  }

  function set_autoNumeric() {
    $.each(price_selectors, function (index, value) {
      $(value).attr({
        type: "text"
      });
      new AutoNumeric($(value)[0]).british({
        'unformatOnSubmit': true
      });
    });
  }

  function set_form_changed() {
    $('.product_form input, .product_form select').change(function () {
      form_changed = true;
      $('.save_button').prop('disabled', false);
    });
  }

  $(document).ready(function () {

    set_variation_hover_style();
    variation_link_click();
    set_autoNumeric();

    $(document).ready(function () { // After selectize and autoNumeric
      set_form_changed();
    });

  });
</script>
{% endblock %}